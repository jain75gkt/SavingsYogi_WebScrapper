!function(){"use strict";const e={getUIDCookie:"https://apis.bmo.com/api/ent-secure/utility/uuid/contact-handler/user-profiles/get",sendData:"https://apis.bmo.com/api/ent-secure/utility/uuid/contact-handler/user-profiles",xApiKey:"",xApiKeyGetEncryptionKey:"",authorizationToken:"eyJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJhcGkyLXNpdDIuYm1vZ2MubmV0Iiwic3ViIjoiYW5vbnltb3VzIiwiZXhwIjoxNzU1MjY3MTMwLCJpYXQiOjE3NTI2NzUxMzAsInNjb3BlIjoib25wcmVtLWxlZ2FjeS1zY29wZS0xIn0.jQ44gG-fkx5yshJtaxNcO-Ycu5JMwsG2VLsMQi8hY7ulCyR_Les5VXfIRNCK5emdwZeAUTgdIslekuPTFPE3yR7wDW-JOQQWtqtnkDW4SYu9TRSZsLSA4-qIl-G5Il5T6S5X3BXBheGuNYklNba_hv-BaAo7yaSmlOY17ZhSiK3Bgzg2I47qO8N4ZdfIomMBWZoc0hhWb_mXhOKNrfWssGyFfINJ4MS1laArbig4EfCindMC4WqtumSRm449-2g0vDHgw4zzCmKmN_B-8k-tfXi-7nViqeN4WaAxoJ97B8hSkvHF6O4QqFU2s0JkovCPpq1E5idUCDZL7bhrczAU4Q,"},t={getUserLocation:"https://geo.bmo.com/location.json"},n={getPublicKey:"https://apis.bmo.com/api/issued-device-administration/client-data-encryption-key/get"},o=async e=>{try{const n=await fetch(t.getUserLocation);if(!n.ok)throw new Error(`Network request to Geolocation API failed! Recieved status code: ${n.status}`);const o=await n.json(),a={ipAddress:o.trueClientIP,geoLocation:`${o.stateOrProvince}, ${o.country}`},r={country:o.country,state:o.stateOrProvince,city:o.city,psCode:o.zipOrPostalCode};Object.assign(e.browserInfo,a),Object.assign(e.nonPiiData,r)}catch(n){const e=n;console.error(`Unable to get data from Geolocation API! Error: ${e.message||e}`)}},a=["uID","dar","s_fid","s_vi","s_ecid","AMCV_121534B8527830F30A490D44@AdobeOrg","AMCV_121534B8527830F30A490D44%40AdobeOrg","kndctr_121534B8527830F30A490D44_AdobeOrg_identity","gclid","_evga_52cd","_evga_d0db","_fbp"],r=e=>{e+="=";const t=decodeURIComponent(document.cookie).split(";");for(let n=0;n<t.length;n++){let o=t[n];for(;" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(e))return o.substring(e.length,o.length)}return""},i=e=>{let t={};return a.forEach(e=>{var n;""!==r(e)&&(t[`${n=e,{uID:"uID",dar:"darId",s_fid:"adobeAnalyticsFallbackId",s_vi:"adobeAnalyticsVisitorId",s_ecid:"adobeExperienceCloudId","AMCV_121534B8527830F30A490D44@AdobeOrg":"adobeExperienceVisitorCloudId","AMCV_121534B8527830F30A490D44%40AdobeOrg":"adobeExperienceVisitorCloudId",kndctr_121534B8527830F30A490D44_AdobeOrg_identity:"abobeEcidId",gclid:"googleClickId",_evga_52cd:"salesforcePersonalizationId1",_evga_d0db:"salesforcePersonalizationId2",_fbp:"facebookBrowserId"}[n]}`]=r(e))}),Object.assign(e.universalIds,t)},s=e=>{var t,n,o;let a={};const i=(e=>{if(e){const t=Object.fromEntries(new URLSearchParams(e));let n="";const o=e=>Object.fromEntries(e.split(",").map(e=>{const[t,o]=e.split(":");return"1"===o&&(n+=","+t),[t,"1"===o?"Opted-in":"Opted-out"]}));if(null==t?void 0:t.groups){const e=o(t.groups);return n.substring(1),{date:t.datestamp,groups:e,output:n.substring(1)}}}return!1})(r("OptanonConsent"));return i&&(a.consentTimestamp=null==i?void 0:i.date,a.functionalConsentOptIn=null==(t=null==i?void 0:i.groups)?void 0:t.C0003,a.performanceConsentOptIn=null==(n=null==i?void 0:i.groups)?void 0:n.C0002,a.marketingConsentOptIn=null==(o=null==i?void 0:i.groups)?void 0:o.C0004,a.optInValues=null==i?void 0:i.output),Object.assign(e.consent,a)},d=["https://www.bmo.com/main/personal/credit-cards/cashback/"],c=()=>{const e=window.navigator.userAgent,t=e.indexOf("Trident")>-1||e.indexOf("MSIE")>-1,n=e.indexOf("Edg")>-1||e.indexOf("Edge")>-1,o=window.navigator.userAgent.indexOf("Opera")>-1||window.navigator.userAgent.indexOf("OPR")>-1,a=e.indexOf("Firefox")>-1,r=e.indexOf("Chrome")>-1&&!n&&!o,i=e.indexOf("Safari")>-1&&!r&&!n&&!o;return t?"Internet Explorer":n?"Edge":o?"Opera":a?"Firefox":r?"Chrome":i?"Safari":"Unknown Browser"},l=()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}-${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`},u=()=>{const e=Date.now()+144e5,t={sessionId:`visitor_${Math.random().toString(36).substring(2,9)}`,expirationTime:e};localStorage.setItem("universalIdVisitSession",JSON.stringify(t))};var p={};const m=e=>btoa(String.fromCharCode(...e)),y=async({b64Cek:t,b64IvConcat:o})=>{var a;try{const r=await(async t=>{try{const o=await fetch(t||n.getPublicKey,{method:"POST",headers:{"Content-Type":"application/json","x-fapi-financial-id":"001","x-request-id":l(),"x-app-cat-id":"88335","x-api-key":e.xApiKeyGetEncryptionKey},body:JSON.stringify({originatorData:{applicationCatalogueId:"88335",country:"CA",channel:"HUB"},keyAlias:"alias/SCCG-BMOInternalPubKey",resourceName:"RetrieveIdentificationEvaluation"})});if(!o.ok)throw new Error(`Network request for public key failed! Received status code: ${o.status}`);return await o.json()}catch(o){n.getPublicKey;const e=o;console.error(`Error in getPublicKey: ${e.message||e}`)}})(),i=(e=>{const t=(new TextEncoder).encode(e),n=String.fromCharCode(...t);return btoa(n)})(r.key.keyid),s=r.key.pemContent,d=Uint8Array.from(atob(t),e=>e.charCodeAt(0)),c=await(async e=>{try{const t=e.replace(/-----BEGIN PUBLIC KEY-----/,"").replace(/-----END PUBLIC KEY-----/,"").replace(/[\r\n\s]+/g,""),n=Uint8Array.from(atob(t),e=>e.charCodeAt(0));return await crypto.subtle.importKey("spki",n,{name:"RSA-OAEP",hash:"SHA-256"},!1,["encrypt"])}catch(t){throw console.error("Failed to import PEM public key:",t),new Error("Invalid public key format or unsupported key algorithm.")}})(s),u=await(null==(a=window.crypto)?void 0:a.subtle.encrypt({name:"RSA-OAEP"},c,d)),p=await crypto.subtle.digest("SHA-256",d),y=m(new Uint8Array(u));return{"x-crypto-key":`${i}.${y}.${m(new Uint8Array(p))}.${o}.GCM-256`}}catch(r){throw console.error("Error building x-crypto-key header:",r),new Error("Failed to build encryption header.")}},f={"Content-Type":"application/json","x-fapi-interaction-id":"universal-id-fapi-interaction-id","x-client-id":"universal-id-client-id","x-request-id":l(),"x-api-key":e.xApiKey,Authorization:e.authorizationToken,"x-crypto-key":""},g=async(t,n)=>{try{const o={...f,...n?{"x-crypto-key":n}:""},a=await fetch(e.sendData,{method:"POST",headers:o,body:JSON.stringify(t)});if(!a.ok)throw new Error(`Network request to Connector Grid failed! Received status code: ${a.status}`);return await a.json()}catch(o){const e=o;console.error(`Error in sendDataToConnectorGrid: ${e.message||e}`)}},h=async(t,n)=>{const o=JSON.parse(JSON.stringify(t));delete o.universalIds.uID;try{const t={...f,...n?{"x-crypto-key":n}:""},a=await fetch(e.getUIDCookie,{method:"POST",credentials:"include",headers:t,body:JSON.stringify(o)});if(!a.ok)throw new Error(`Network request to Connector Grid failed! Received status code: ${a.status}`);return await a.json()}catch(a){const e=a;console.error(`Error in getUniversalIdCookie: ${e.message||e}`)}},w={firstName:["firstname","first-name","firstName","name","contactName","first_name","FirstName","FIRSTNAME","VendorFirstName","clientFirstName","firstName1","username","nameInput","personal-info-component-first-name-input-element","name-block-first-name-element"],lastName:["lastname","last-name","lastName","last_name","LastName","LASTNAME","VendorLastName","clientLastName","lastName1","personal-info-component-last-name-input-element","name-block-last-name-element"],middleName:["middleName","name-block-middle-name-element"],fullName:["contactName","name","fullname","personName","firstLastName","placeholder-id"],emailAddress:["emailAddress","email","emailAddr","EmailAddress","fromAddress","emailExistingClient","EMAIL","emailaddress","clientEmailAddr","phone-page-component-email-input-form-element","email-input-field-element"],primaryPhoneNum:["mobile","phoneNum","phoneNumber","PhoneNumber","PHONENUMBER","homephone","phone","clientPhoneNum","phone-page-component-phone-input-element","phone-block-input-field-element"],secondaryPhoneNum:["secondaryPhoneNum","placeholder-id"],additionalContactInfo:["preferredContactInfo","placeholder-id"],dateOfBirth:["dateOfBirth","date-of-birth-date-picker-element","dob-input-field-element"],addressLineOne:["address","address1","streetAddress","address-page-component-streetNumber-input-element","address-page-component-streetName-input-element","address-input-address-input-field-element","address-input-field-street-name-field-element"],addressLineTwo:["address2","address-page-component-streetName-input-element"],city:["city","CITY","clientCity","address-page-component-city-input-element","address-input-field-city-input-field-element"],state:["visaCategory","state","province","PROVINCEFIELD","clientProvince","address-page-component-province-input-element","address-input-field-province-input-field-element"],psCode:["zip","zipCode","postalCode","POSTALCODE","zipcode","address-page-component-postalCode-input-element","address-input-field-postal-code-input-field-element"],title:["Title","placeholder-id"],gender:["gender","placeholder-id"]},b=e=>{for(const t in w)if(Object.prototype.hasOwnProperty.call(w,t)&&w[t].includes(e))return t;return e},I=async(e,t)=>{let n={},o={...t.nonPiiData??{}};if(!t.SECURED.encrypted)try{n=JSON.parse(t.SECURED.data)}catch(f){}for(const r in e){const t=b(r);w.hasOwnProperty(t)&&(t in n?n[t]=e[r]:t in o&&(o[t]=e[r]))}if("applicationId"in e&&"string"==typeof e.applicationId){t.universalIds.applicationId=e.applicationId}const a={...n},{iv:i,cek:s,aad:d,encryptedData:c,headers:l}=await(async({data:e})=>{try{const t=new TextEncoder,n=crypto.getRandomValues(new Uint8Array(32)),o=crypto.getRandomValues(new Uint8Array(12)),a=p.AAD||"RandomAADValue",r=t.encode(a),i=new Uint8Array(o.length+r.length);i.set(o,0),i.set(r,o.length);const s=await crypto.subtle.importKey("raw",n,{name:"AES-GCM"},!1,["encrypt"]),d=t.encode(JSON.stringify(e)),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:o,additionalData:r,tagLength:128},s,d),l=new Uint8Array(c),u=l.subarray(0,l.length-16),f=l.subarray(l.length-16),g=m(i),h=m(o),w=m(n),b=await y({b64Cek:w,b64IvConcat:g});return{iv:h,cek:w,aad:a,encryptedData:`${m(u)}|${m(f)}`,headers:b}}catch(t){throw console.error("Encryption process failed:",t),new Error("Encryption failed. Please check data.")}})({data:a}),u={...t,SECURED:{encrypted:!0,data:c},nonPiiData:{...t.nonPiiData??{},...o}};return r("uID")?g(u,l["x-crypto-key"]):h(u,l["x-crypto-key"])},C=()=>{const e=window.location.hostname,t=e.split(".");return t.length<=2?e:`.${t.slice(-2).join(".")}`},O={originatorData:{applicationCatalogueId:"required-test-data",country:"required-test-data",transitNumber:"",locationId:"",locationType:"",channel:"required-test-data",employeeUserId:"",employeeUserName:""},SECURED:{encrypted:!1,data:JSON.stringify({firstName:"",lastName:"",middleName:"",fullName:"",dateOfBirth:"",emailAddress:"",primaryPhoneNum:"",secondaryPhoneNum:"",addressLineOne:"",addressLineTwo:"",additionalContactInfo:"",gender:""})},universalIds:{uID:"required-test-data",darId:"",adobeAnalyticsFallbackId:"",adobeAnalyticsVisitorId:"",adobeExperienceCloudId:"",adobeExperienceVisitorCloudId:"",abobeEcidId:"",googleClickId:"",salesforcePersonalizationId1:"",salesforcePersonalizationId2:"",facebookBrowserId:"",applicationId:""},browserInfo:{ipAddress:"",userAgent:"",geoLocation:"",browserType:"",language:"",refDomain:"",domain:"",cookieExpiryInDays:365},nonPiiData:{title:"",city:"",state:"",country:"",psCode:""},consent:{functionalConsentOptIn:"",performanceConsentOptIn:"",marketingConsentOptIn:"",optInValues:"",consentTimestamp:""}};window.universalId=window.universalId||{},window.universalId.sendFormData=async e=>new Promise(async t=>{k(O),i(O),await o(O),t(await I(e,O))});const k=e=>{const t={userAgent:window.navigator.userAgent,browserType:c(),language:document.documentElement.lang,refDomain:document.referrer,domain:C()};Object.assign(e.browserInfo,t)},A=async e=>{k(e),i(e),s(e),await o(e)},v=async()=>{const e=localStorage.getItem("universalIdVisitSession");if(e){const t=JSON.parse(e),n=Date.now(),o=t.expirationTime,a=r("uID");(e=>{const t=window.location.href;return e.some(e=>e===t)})(d)?(await A(O),a?g(O):h(O)):a?n>=o&&(await A(O),localStorage.removeItem("universalIdVisitSession"),u(),a?g(O):h(O)):(await A(O),h(O))}else{u(),await A(O);r("uID")?g(O):h(O)}},N="#onetrust-consent-sdk";let E="";const S=(e=>{let t=!0;return(...n)=>{t&&(t=!1,queueMicrotask(()=>{t=!0,e(...n)}))}})(async e=>{s(e);const t=r("OptanonConsent")??"";if(t===E)return;E=t;const n=r("uID");await A(e),n?g(e):h(e)});let D=!1;async function x(){try{await((e,t={})=>{const n=t.timeoutMs??5e3;return new Promise(t=>{let o=!1,a=null,r=null;const i=e=>{if(!o){o=!0;try{null==a||a.disconnect()}catch{}a=null,null!==r&&(window.clearTimeout(r),r=null),t(e)}};document.querySelector(e)?i("present-at-start"):document.cookie.includes("OptanonConsent")?i("cookie-present"):(a=new MutationObserver(()=>{document.querySelector(e)?i("found by MO"):document.cookie.includes("OptanonConsent")&&i("cookie-present")}),a.observe(document.body,{childList:!0,subtree:!0}),r=window.setTimeout(()=>i("timeout"),n))})})(N,{timeoutMs:5e3}),(()=>{var e;const t=["#onetrust-accept-btn-handler",".save-preference-btn-handler",".onetrust-close-btn-handler"].join(",");if(D)return;if(null==(e=window.OneTrust)?void 0:e.OnConsentChanged)return window.OneTrust.OnConsentChanged(()=>S(O)),void(D=!0);const n=document.querySelector(N);if(!n)return;const o=e=>{var n;e.target instanceof HTMLElement&&(e.target.matches(t)&&("keydown"===e.type&&"Enter"!==(n=e).key&&" "!==n.key||setTimeout(()=>S(O),50)))};n.addEventListener("click",o),n.addEventListener("keydown",o),D=!0})(),await((e=5e3,t=100)=>new Promise(n=>{const o=performance.now();!function a(){return document.cookie,document.cookie.includes("OptanonConsent=")&&document.cookie.includes("&groups=")||performance.now()-o>e?n():void setTimeout(a,t)}(),r("OptanonConsent")}))()}catch(e){console.error("UniversalIdFlow pre-check crash: failed while waiting for Onetrust banner, or attaching consent.",e)}try{await v()}catch(e){console.error("checkUniversalIdVisitSession() crashed: failed during visit/session check",e)}}"complete"===document.readyState?x():window.addEventListener("load",()=>{x()},{once:!0})}();
//# sourceMappingURL=universalIdCore.min.js.map
