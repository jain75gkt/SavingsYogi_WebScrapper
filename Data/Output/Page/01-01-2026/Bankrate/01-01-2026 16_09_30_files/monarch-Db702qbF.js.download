window.fetchInjectableComponent=async(t,e=null)=>{const n=await(await fetch(`/api/v2/injectable/${t.replace(/^\/|\/$/g,"")}/`)).json();return e&&(n.html=replaceEditableContent(n.html,e)),n};window.replaceEditableContent=(t,e)=>{if(e??!1)if(Array.isArray(e))for(let l=0;l<e.length;l+=1){const n=e[l].key??!1,r=e[l].value??!1;n&&r&&(t=t.replace(new RegExp(`::${n}::`,"g"),r))}else typeof e=="object"&&Object.entries(e).forEach(([l,n])=>{t=t.replace(new RegExp(`::${l}::`,"g"),n)});return t};window.monarchExternalStatus=window.monarchExternalStatus||{};window.createInjectableElements=t=>{const e={htmlElement:document.createElement("div"),scriptElements:[],styleElements:[],externalSources:[],delayRecommended:!1};return Object.entries(t.scripts_html).forEach(([n,r])=>{const s=r.match(/<script\b[^>]+src="([^"]+)"[^>]*><\/script>/g);s&&s.forEach(o=>{var d;const a=o.match(/src="([^"]+)"/)[1],i=(d=o.match(/type="([^"]+)"/))==null?void 0:d[1];if(document.querySelector(`script[src="${a}"]`))return;const m=document.createElement("script");m.src=a,i&&(m.type=i),window.monarchExternalStatus[a]="pending",e.externalSources.push(a),m.addEventListener("load",h=>{window.monarchExternalStatus[h.target.getAttribute("src")]="loaded",document.dispatchEvent(new Event("monarch:external:loaded"))}),e.scriptElements.push(m),t.scripts_html[n]=t.scripts_html[n].replace(o,"").trim()});const c=t.scripts_html[n].match(/<link\b[^>]*>/g);if(c&&c.forEach(o=>{t.scripts_html[n]=t.scripts_html[n].replace(o,"").trim()}),t.scripts_html[n]){const o=/<script\b[^>]*>([\s\S]*?)<\/script>/gm,a=t.scripts_html[n].match(o);a&&a.forEach(i=>{const m=document.createElement("script");m.innerHTML=i.replace(o,"$1"),e.scriptElements.push(m)})}}),e.htmlElement.innerHTML=`
      ${t.styles_html.default??""}
      ${t.styles_html.treasury??""}
      ${t.html?t.html:""}
  `,e.htmlElement.querySelectorAll('link[rel="stylesheet"]').forEach(n=>{const r=n.getAttribute("href");window.monarchExternalStatus[r]="pending",n.addEventListener("load",()=>{window.monarchExternalStatus[r]="loaded",document.dispatchEvent(new Event("monarch:external:loaded"))}),e.styleElements.push(n),e.externalSources.push(r),e.htmlElement.removeChild(n)}),e.htmlElement.querySelectorAll('link[rel="preload"][as="style"]').forEach(n=>{e.htmlElement.removeChild(n)}),e.externalSources.length&&t.html.includes("x-data")&&(e.delayRecommended=!0),e};window.renderAndPlaceInjectableElements=(t,e,l=null)=>{const n=document.querySelector(e);l||(l=n.getAttribute("data-content-strategy")??"append"),["after","append","before","prepend","replace","replaceWith"].indexOf(l)===-1&&(l="append");const r=createInjectableElements(t);return r.scriptElements.forEach(s=>document.head.appendChild(s)),r.styleElements.forEach(s=>document.head.appendChild(s)),new Promise(s=>{l==="replace"?r.delayRecommended?document.addEventListener("monarch:external:loaded",()=>{r.externalSources.every(c=>window.monarchExternalStatus[c]==="loaded")&&(document.dispatchEvent(new Event("alpine:init")),n.innerHTML="",n.append(r.htmlElement),_Beam.reload(),s())}):(n.innerHTML="",n.append(r.htmlElement),s()):r.delayRecommended?document.addEventListener("monarch:external:loaded",()=>{r.externalSources.every(c=>window.monarchExternalStatus[c]==="loaded")&&(document.dispatchEvent(new Event("alpine:init")),n[l](r.htmlElement),_Beam.reload(),s())}):(n[l](r.htmlElement),s())})};document.addEventListener("alpine:init",()=>{Alpine.store("monarch")||(Alpine.store("monarch",{slots:{},loaded:!1,init(){this.registerAttributeSlots(),cohesion("monarch:done",(t,e)=>{var n,r,s,c;if(t){Alpine.store("monarch").loaded=!0;return}const l=[];if(((r=(n=e==null?void 0:e.source)==null?void 0:n.trafficFlow)==null?void 0:r.returnType)==="experience"&&e.source.trafficFlow.value.experienceValues.forEach(o=>{(Alpine.store("monarch").slots[o.slot.customId]??!1)&&(Alpine.store("monarch").slots[o.slot.customId]={...Alpine.store("monarch").slots[o.slot.customId],...o.value},(o.value.data.injectableSlug??!1)&&l.push(Alpine.store("monarch").getInjectable(o,"injectableSlug")))}),((c=(s=e==null?void 0:e.source)==null?void 0:s.trafficFlow)==null?void 0:c.returnType)==="connection"){const o=e.source.trafficFlow.value;if(!o.html)console.error("Monarch connection missing html content:",o);else if(!o.target_element_selector)console.error("Monarch connection missing target_element_selector:",o);else{const a=o.target_element_selector,i=a.startsWith("#")?a:`#${a}`,m=o.content_placement_strategy||"replace";l.push(renderAndPlaceInjectableElements(o,i,m))}}Promise.allSettled(l).then(()=>{Alpine.store("monarch").loaded=!0,_Beam.reload()})}),cohesion("error",()=>{Alpine.store("monarch").loaded=!0})},getData(t){return this.slots[t]??null},getComponent(t){return this.slots[t].componentCustomId??!1?{id:this.slots[t].componentId,customId:this.slots[t].componentCustomId,name:this.slots[t].componentName}:null},async getInjectable(t,e){const l=await fetchInjectableComponent(t.value.data[e],t.value.data.editable??null);Alpine.store("monarch").slots[t.slot.customId].alpineComponent?Alpine.store("monarch").slots[t.slot.customId].data.html=l.html:await renderAndPlaceInjectableElements(l,`[data-monarch-slot="${t.slot.customId}"]`),_Beam.reload()},registerSlot(t){this.slots[t]={alpineComponent:!0,data:{}}},registerAttributeSlots(){document.querySelectorAll("[data-monarch-slot]").forEach(e=>{const l=e.getAttribute("data-monarch-slot");this.slots[l]={alpineComponent:!1,data:{}}})}}),Alpine.data("monarchExperience",(t,e=[],l={})=>{let n=[];return Array.isArray(e)?n=e:e&&(n=[e]),{slotId:t,allowedComponentCustomIds:n,defaults:l,init(){Alpine.store("monarch").registerSlot(this.slotId)},allowedComponent(){var r;return this.allowedComponentCustomIds.length===0||this.allowedComponentCustomIds.includes((r=this.component())==null?void 0:r.customId)},component(){return Alpine.store("monarch").getComponent(this.slotId)},data(r){var s;return this.allowedComponent()?((s=Alpine.store("monarch").getData(this.slotId))==null?void 0:s.data[r])??this.defaults[r]??null:this.defaults[r]??null},experiencesLoaded(){return Alpine.store("monarch").loaded}}}))});
