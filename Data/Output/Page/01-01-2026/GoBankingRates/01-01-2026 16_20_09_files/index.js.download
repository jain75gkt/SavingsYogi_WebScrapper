(function(){const config=Object.assign({event:false,session:null,onComplete:null,disableSelector:null},typeof ctiLinkConfig==="undefined"?{}:ctiLinkConfig);const renderPixels=function(html){const iframe=document.createElement("iframe");Object.assign(iframe.style,{position:"absolute",bottom:0,left:0,height:"1px",width:"1px",visibility:"hidden",pointerEvents:"none"});document.body.appendChild(iframe);iframe.contentDocument.write(html);iframe.contentDocument.close()};const getQP=function(input,visitIdCookie,visitorIdCookie){let qParms="";let firstQParms;input.substring(1).split("&").forEach(function(e,i,a){if(e==="")return;firstQParms=i+1==1;const lastQParms=i+1==a.length;const eArr=e.split("=");if(firstQParms){qParms+="?"}qParms+=encodeURIComponent(eArr[0])+"="+encodeURIComponent(eArr[1]);if(!lastQParms){qParms+="&"}});if(visitIdCookie&&visitorIdCookie){qParms+="&visit_id="+encodeURIComponent(visitIdCookie)+"&visitor_id="+encodeURIComponent(visitorIdCookie)}return qParms};function getCookieValue(cookieName){const cookies=document.cookie.split("; ");for(let i=0;i<cookies.length;i++){const cookie=cookies[i].split("=");if(cookie[0]===cookieName){return decodeURIComponent(cookie[1])}}return null}const fn=function(){const anchors={};const apiPayload=[];const sl=typeof config.session==="string"?config.session:null;const shouldCheckDisableSelector=typeof config.disableSelector==="function";const query=document.querySelectorAll('a[href*="products.gobankingrates.com/pub/"], a[href*="cardcritics.com/pub/"]');if(query.length<1)return;for(let i=0;i<query.length;i++){const link=query[i];if(shouldCheckDisableSelector&&config.disableSelector(link)){continue}const url=new URL(link.href);const pub=url.pathname.replace("/pub/","").split("/")[0];const matches=Object.keys(anchors).filter(function(s){return s.indexOf(pub+url.search)!==-1});const visitIdCookie=getCookieValue("visit_id");const visitorIdCookie=getCookieValue("visitor_id");if(matches.length>0){anchors[matches[0]].url_elements.push(link)}else{const anchorId="pub_"+(Object.keys(anchors).length+1)+"_"+pub+url.search;anchors[anchorId]={pub:pub,url:url,search_encode:getQP(url.search,visitIdCookie,visitorIdCookie),url_elements:[link]}}}if(Object.keys(anchors).length<1)return;Object.keys(anchors).forEach(function(k,i){const queryString=anchors[k].search_encode;const params=new URLSearchParams(queryString.startsWith("?")?queryString:"?"+queryString);if(document.placementCrawled.indexOf(anchors[k].pub+queryString)===-1&&!params.has("ak")){apiPayload.push({el_id:"pub_"+(i+1),pp:anchors[k].pub,q:queryString,sl:sl});document.placementCrawled.push(anchors[k].pub+queryString)}});if(apiPayload.length===0)return;const origins={"www.gobankingrates.com":"https://www.gobankingrates.com","stage-www.gobankingrates.com":"https://stage-www.gobankingrates.com","cardcritics.com":"https://cardcritics.com","stage.cardcritics.com":"https://stage.cardcritics.com","www.cardcritics.com":"https://www.cardcritics.com",check(host){const regex=/^[a-z]+-\d+(-www\.gobankingrates\.com|\.cardcritics\.com)$/;return regex.test(host)}};let origin="";const host=window.location.hostname;if(origins.hasOwnProperty(host)){origin=origins[host]}else if(origins.check(host)){origin="https://"+host}else{origin="https://stage-products.gobankingrates.com"}const batchSize=50;const batches=[];for(let i=0;i<apiPayload.length;i+=batchSize){batches.push(apiPayload.slice(i,i+batchSize))}let completedBatches=0;let allResponses=[];let allPixels="";const checkAndFinalize=function(){completedBatches++;if(completedBatches===batches.length){if(config.hasOwnProperty("onComplete")&&typeof config.onComplete==="function"){const onCompleteData=allResponses.filter(function(r){return r.hasOwnProperty("el_id")&&r.el_id!=="meta"}).map(function(r){if(r.hasOwnProperty("ak")&&typeof r.ak==="string"&&r.ak.trim()==""||r.hasOwnProperty("ak")&&r.ak==null){delete r.ak}return r});config.onComplete(onCompleteData)}renderPixels(allPixels.trim())}};const handleBatchResponse=function(response){allResponses=allResponses.concat(response);let pixels="";response.filter(function(r){return r.el_id!=="meta"}).map(function(r){const urlId=r.el_id;const anchorId=Object.keys(anchors).filter(function(s){return s.indexOf(urlId)!==-1});if(r.f==""){r.f=0}if(anchorId.length>0){const anchor=anchors[anchorId[0]];anchor.url.searchParams.set("flight_id",r.f);anchor.url.searchParams.set("ak",r.ak);anchor.url.searchParams.set("sl",r.sl);anchor.url_elements.forEach(function(e,i){anchor.url_elements[i].setAttribute("href",anchor.url)})}if(r.cp){pixels+=" "+r.cp}});if(pixels.trim()){allPixels+=pixels.trim()+" "}checkAndFinalize()};const handleBatchFailure=function(){checkAndFinalize()};batches.forEach(function(batch){const xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){if(this.readyState==4){if(this.status==200){const response=JSON.parse(this.responseText);handleBatchResponse(response)}else{handleBatchFailure()}}};xhr.onerror=function(){handleBatchFailure()};xhr.open("POST",origin+"/api/d2c/impressions");xhr.setRequestHeader("Content-Type","application/json");xhr.send(JSON.stringify(batch))})};document.placementCrawled=[];let handle;if(config.event){window.addEventListener("message",event=>{if(event.data==="cti-d2c-link"){if(window.ABTasty){if(handle){window.clearInterval(handle)}handle=window.setInterval(fn,2e3)}else{fn()}}})}else{if(window.ABTasty){window.setInterval(fn,2e3)}else if(document.readyState==="complete"||document.readyState==="interactive"){setTimeout(fn,1)}else{document.addEventListener("DOMContentLoaded",fn)}}})();